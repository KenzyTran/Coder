{"ast":null,"code":"import { createElementVNode as _createElementVNode, createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, withCtx as _withCtx, createVNode as _createVNode, createCommentVNode as _createCommentVNode, openBlock as _openBlock, createBlock as _createBlock, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  key: 1,\n  class: \"negative-balance-warning\"\n};\nconst _hoisted_2 = {\n  class: \"action-buttons\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_upload = _resolveComponent(\"el-upload\");\n  const _component_el_table_column = _resolveComponent(\"el-table-column\");\n  const _component_el_table = _resolveComponent(\"el-table\");\n  const _component_el_alert = _resolveComponent(\"el-alert\");\n  const _component_el_checkbox = _resolveComponent(\"el-checkbox\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  return _openBlock(), _createElementBlock(\"div\", null, [_createVNode(_component_el_upload, {\n    class: \"upload-demo\",\n    drag: \"\",\n    action: \"/api/transactions/upload\",\n    \"show-file-list\": false,\n    accept: \".csv,.xlsx\",\n    \"before-upload\": $options.beforeUpload,\n    \"on-success\": $options.handleFileSuccess,\n    \"on-error\": $options.handleFileError\n  }, {\n    default: _withCtx(() => _cache[1] || (_cache[1] = [_createElementVNode(\"i\", {\n      class: \"el-icon-upload\"\n    }, null, -1 /* HOISTED */), _createElementVNode(\"div\", {\n      class: \"el-upload__text\"\n    }, [_createTextVNode(\"Drag the CSV/XLSX file here or \"), _createElementVNode(\"em\", null, \"click to upload\")], -1 /* HOISTED */)])),\n    _: 1 /* STABLE */,\n    __: [1]\n  }, 8 /* PROPS */, [\"before-upload\", \"on-success\", \"on-error\"]), _createCommentVNode(\" Main transactions table \"), $data.transactions.length > 0 ? (_openBlock(), _createBlock(_component_el_table, {\n    key: 0,\n    data: $data.transactions,\n    style: {\n      \"width\": \"100%\",\n      \"margin-bottom\": \"20px\"\n    }\n  }, {\n    default: _withCtx(() => [_createVNode(_component_el_table_column, {\n      type: \"index\",\n      label: \"#\",\n      width: \"50\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"tradeDate\",\n      label: \"Ngày GD\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"symbol\",\n      label: \"Mã CK\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"type\",\n      label: \"Loại GD\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"volume\",\n      label: \"Khối lượng\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"price\",\n      label: \"Giá\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"feeRate\",\n      label: \"Tỷ lệ phí\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"taxRate\",\n      label: \"Tỷ lệ thuế\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"runningBalance\",\n      label: \"Running Balance\",\n      \"cell-class-name\": $options.getBalanceClass\n    }, null, 8 /* PROPS */, [\"cell-class-name\"])]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"data\"])) : _createCommentVNode(\"v-if\", true), _createCommentVNode(\" Negative balance warning table \"), $options.hasNegativeBalances ? (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createVNode(_component_el_alert, {\n    title: \"Cảnh báo: Có giao dịch dẫn đến số dư âm\",\n    type: \"warning\",\n    closable: false,\n    \"show-icon\": \"\"\n  }, {\n    default: _withCtx(() => _cache[2] || (_cache[2] = [_createElementVNode(\"p\", null, \"Vui lòng kiểm tra các giao dịch sau:\", -1 /* HOISTED */)])),\n    _: 1 /* STABLE */\n  }), _createVNode(_component_el_table, {\n    data: $options.negativeBalanceTransactions,\n    style: {\n      \"width\": \"100%\",\n      \"margin\": \"10px 0 20px 0\"\n    },\n    border: \"\"\n  }, {\n    default: _withCtx(() => [_createVNode(_component_el_table_column, {\n      type: \"index\",\n      label: \"#\",\n      width: \"50\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"symbol\",\n      label: \"Mã CK\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"runningBalance\",\n      label: \"Số dư cuối\"\n    }), _createVNode(_component_el_table_column, {\n      label: \"Chi tiết giao dịch\"\n    }, {\n      default: _withCtx(scope => [_createVNode(_component_el_table, {\n        data: $options.getTransactionsForSymbol(scope.row.symbol),\n        style: {\n          \"width\": \"100%\"\n        },\n        size: \"small\"\n      }, {\n        default: _withCtx(() => [_createVNode(_component_el_table_column, {\n          prop: \"tradeDate\",\n          label: \"Ngày GD\",\n          width: \"120\"\n        }), _createVNode(_component_el_table_column, {\n          prop: \"type\",\n          label: \"Loại GD\",\n          width: \"100\"\n        }), _createVNode(_component_el_table_column, {\n          prop: \"volume\",\n          label: \"Khối lượng\",\n          width: \"100\"\n        }), _createVNode(_component_el_table_column, {\n          prop: \"price\",\n          label: \"Giá\",\n          width: \"100\"\n        })]),\n        _: 2 /* DYNAMIC */\n      }, 1032 /* PROPS, DYNAMIC_SLOTS */, [\"data\"])]),\n      _: 1 /* STABLE */\n    })]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"data\"]), _createVNode(_component_el_checkbox, {\n    modelValue: $data.ignoreNegativeBalances,\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $data.ignoreNegativeBalances = $event),\n    style: {\n      \"margin-bottom\": \"20px\"\n    }\n  }, {\n    default: _withCtx(() => _cache[3] || (_cache[3] = [_createTextVNode(\" Bỏ qua cảnh báo số dư âm và tiếp tục import \")])),\n    _: 1 /* STABLE */,\n    __: [3]\n  }, 8 /* PROPS */, [\"modelValue\"])])) : _createCommentVNode(\"v-if\", true), _createElementVNode(\"div\", _hoisted_2, [_createVNode(_component_el_button, {\n    type: \"primary\",\n    onClick: $options.importTransactions,\n    disabled: $data.transactions.length === 0 || $options.hasNegativeBalances && !$data.ignoreNegativeBalances\n  }, {\n    default: _withCtx(() => _cache[4] || (_cache[4] = [_createTextVNode(\" Import \")])),\n    _: 1 /* STABLE */,\n    __: [4]\n  }, 8 /* PROPS */, [\"onClick\", \"disabled\"])])]);\n}","map":{"version":3,"names":["key","class","_createElementBlock","_createVNode","_component_el_upload","drag","action","accept","$options","beforeUpload","handleFileSuccess","handleFileError","default","_withCtx","_cache","_createElementVNode","_createTextVNode","_","__","_createCommentVNode","$data","transactions","length","_createBlock","_component_el_table","data","style","_component_el_table_column","type","label","width","prop","getBalanceClass","hasNegativeBalances","_hoisted_1","_component_el_alert","title","closable","negativeBalanceTransactions","border","scope","getTransactionsForSymbol","row","symbol","size","_component_el_checkbox","modelValue","ignoreNegativeBalances","$event","_hoisted_2","_component_el_button","onClick","importTransactions","disabled"],"sources":["/home/kiet/projects/agents/3_crew/engineering_team/frontend/src/components/TransactionUploader.vue"],"sourcesContent":["<template>\n  <div>\n    <el-upload\n      class=\"upload-demo\"\n      drag\n      action=\"/api/transactions/upload\"\n      :show-file-list=\"false\"\n      accept=\".csv,.xlsx\"\n      :before-upload=\"beforeUpload\"\n      :on-success=\"handleFileSuccess\"\n      :on-error=\"handleFileError\">\n      <i class=\"el-icon-upload\"></i>\n      <div class=\"el-upload__text\">Drag the CSV/XLSX file here or <em>click to upload</em></div>\n    </el-upload>\n\n    <!-- Main transactions table -->\n    <el-table\n      v-if=\"transactions.length > 0\"\n      :data=\"transactions\"\n      style=\"width: 100%; margin-bottom: 20px\">\n      <el-table-column type=\"index\" label=\"#\" width=\"50\"></el-table-column>\n      <el-table-column prop=\"tradeDate\" label=\"Ngày GD\"></el-table-column>\n      <el-table-column prop=\"symbol\" label=\"Mã CK\"></el-table-column>\n      <el-table-column prop=\"type\" label=\"Loại GD\"></el-table-column>\n      <el-table-column prop=\"volume\" label=\"Khối lượng\"></el-table-column>\n      <el-table-column prop=\"price\" label=\"Giá\"></el-table-column>\n      <el-table-column prop=\"feeRate\" label=\"Tỷ lệ phí\"></el-table-column>\n      <el-table-column prop=\"taxRate\" label=\"Tỷ lệ thuế\"></el-table-column>\n      <el-table-column\n        prop=\"runningBalance\"\n        label=\"Running Balance\"\n        :cell-class-name=\"getBalanceClass\">\n      </el-table-column>\n    </el-table>\n\n    <!-- Negative balance warning table -->\n    <div v-if=\"hasNegativeBalances\" class=\"negative-balance-warning\">\n      <el-alert\n        title=\"Cảnh báo: Có giao dịch dẫn đến số dư âm\"\n        type=\"warning\"\n        :closable=\"false\"\n        show-icon>\n        <template #default>\n          <p>Vui lòng kiểm tra các giao dịch sau:</p>\n        </template>\n      </el-alert>\n\n      <el-table\n        :data=\"negativeBalanceTransactions\"\n        style=\"width: 100%; margin: 10px 0 20px 0\"\n        border>\n        <el-table-column type=\"index\" label=\"#\" width=\"50\"></el-table-column>\n        <el-table-column prop=\"symbol\" label=\"Mã CK\"></el-table-column>\n        <el-table-column prop=\"runningBalance\" label=\"Số dư cuối\"></el-table-column>\n        <el-table-column label=\"Chi tiết giao dịch\">\n          <template #default=\"scope\">\n            <el-table\n              :data=\"getTransactionsForSymbol(scope.row.symbol)\"\n              style=\"width: 100%\"\n              size=\"small\">\n              <el-table-column prop=\"tradeDate\" label=\"Ngày GD\" width=\"120\"></el-table-column>\n              <el-table-column prop=\"type\" label=\"Loại GD\" width=\"100\"></el-table-column>\n              <el-table-column prop=\"volume\" label=\"Khối lượng\" width=\"100\"></el-table-column>\n              <el-table-column prop=\"price\" label=\"Giá\" width=\"100\"></el-table-column>\n            </el-table>\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <el-checkbox v-model=\"ignoreNegativeBalances\" style=\"margin-bottom: 20px\">\n        Bỏ qua cảnh báo số dư âm và tiếp tục import\n      </el-checkbox>\n    </div>\n\n    <div class=\"action-buttons\">\n      <el-button \n        type=\"primary\" \n        @click=\"importTransactions\" \n        :disabled=\"transactions.length === 0 || (hasNegativeBalances && !ignoreNegativeBalances)\">\n        Import\n      </el-button>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { ElMessage } from 'element-plus';\nimport axios from 'axios';\n\nexport default {\n  data() {\n    return {\n      transactions: [],\n      ignoreNegativeBalances: false\n    };\n  },\n  computed: {\n    hasNegativeBalances() {\n      return this.transactions.some(t => t.runningBalance < 0);\n    },\n    negativeBalanceTransactions() {\n      const symbols = [...new Set(this.transactions\n        .filter(t => t.runningBalance < 0)\n        .map(t => t.symbol))];\n      \n      return symbols.map(symbol => {\n        const transactions = this.getTransactionsForSymbol(symbol);\n        const lastTransaction = transactions[transactions.length - 1];\n        return {\n          symbol,\n          runningBalance: lastTransaction.runningBalance,\n          transactions\n        };\n      });\n    }\n  },\n  methods: {\n    beforeUpload(file) {\n      const isCSVOrXLSX = file.type.includes('csv') || file.type.includes('sheet');\n      if (!isCSVOrXLSX) {\n        ElMessage.error('Unsupported file format, please upload CSV/XLSX.');\n      }\n      return isCSVOrXLSX;\n    },\n    handleFileSuccess(response) {\n      this.transactions = response.map((transaction, index) => ({\n        ...transaction,\n        rowIndex: index + 1\n      }));\n      this.ignoreNegativeBalances = false; // Reset checkbox when new file is uploaded\n    },\n    handleFileError(error) {\n      console.error('Upload error:', error);\n      const errorMessage = error.response?.data?.error || 'There was an error processing your file.';\n      ElMessage.error(errorMessage);\n    },\n    async importTransactions() {\n      try {\n        const { data } = await axios.post('/api/transactions/import', {\n          transactions: this.transactions,\n          userId: 'user123', // Hardcoded user id for the example\n          ignoreNegativeBalances: this.ignoreNegativeBalances\n        });\n        \n        if (data.errors.length === 0) {\n          ElMessage.success(`✅ Import thành công ${data.success} giao dịch.`);\n          this.transactions = []; // Clear the table after successful import\n        } else {\n          data.errors.forEach((error) => {\n            ElMessage.error(`❌ Lỗi parsing/giá/khối lượng <= 0 at row: ${error.index + 1}`);\n          });\n        }\n      } catch (error) {\n        console.error('Import error:', error);\n        ElMessage.error('Failed to import transactions.');\n      }\n    },\n    getBalanceClass({ row }) {\n      return row.runningBalance < 0 ? 'negative-balance' : '';\n    },\n    getTransactionsForSymbol(symbol) {\n      return this.transactions\n        .filter(t => t.symbol === symbol)\n        .sort((a, b) => new Date(a.tradeDate) - new Date(b.tradeDate));\n    }\n  }\n};\n</script>\n\n<style scoped>\n.upload-demo {\n  margin-bottom: 20px;\n}\n.el-upload__text {\n  font-size: 16px;\n}\n.negative-balance {\n  background-color: #fff2f0;\n  color: #f56c6c;\n}\n.negative-balance-warning {\n  margin: 20px 0;\n  padding: 15px;\n  border: 1px solid #e6a23c;\n  border-radius: 4px;\n  background-color: #fdf6ec;\n}\n.action-buttons {\n  margin-top: 20px;\n  text-align: right;\n}\n</style> "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}